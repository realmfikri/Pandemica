<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pandemica Control Panel</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.4.0/dist/protobuf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
  </head>
<body>
  <header>
    <h1>Pandemica Simulation Controls</h1>
  </header>

  <main>
    <section class="control">
      <div id="capacityBanner" class="banner" role="status" aria-live="polite">
        Capacity holding: 0 infected of 50 slots. Baseline death rate applies.
      </div>

      <p id="networkStatus" class="status" role="status" aria-live="polite"></p>

      <div class="indicator-grid" aria-live="polite">
        <div class="indicator">
          <div class="indicator-label">Transmission modifier</div>
          <div class="metric-row">
            <strong id="transmissionValue" class="metric">1.00x</strong>
            <span id="infectionProbabilityValue" class="pill">0.0% chance per contact</span>
          </div>
          <p class="hint">Live scaling applied to the base infection probability.</p>
        </div>
        <div class="indicator">
          <div class="indicator-label">Lockdown status</div>
          <div class="metric-row">
            <span id="lockdownBadge" class="pill">Lockdown open</span>
            <strong id="speedBadge" class="metric">1.00x movement speed</strong>
          </div>
          <p class="hint">Movement speed modifier broadcast from the backend.</p>
        </div>
        <div class="indicator">
          <div class="indicator-label">Capacity utilization</div>
          <div class="capacity-bar" aria-hidden="true"><span id="capacityBar"></span></div>
          <div id="capacityValue" class="hint">0% — Within capacity</div>
        </div>
      </div>

      <label for="transmissionSlider">Transmission modifier</label>
      <input id="transmissionSlider" type="range" min="0" max="1" step="0.01" value="1" />
      <div class="value-row">
        <span>Current rate:</span>
        <output aria-live="polite">linked above</output>
      </div>
      <p class="hint">Move the slider to scale the infection probability between agents in real time.</p>

      <div class="field-grid">
        <div>
          <label for="hospitalCapacity">Hospital capacity</label>
          <input id="hospitalCapacity" type="number" min="0" step="1" value="50" />
          <p class="hint">Set the number of simultaneous infections that can be treated without overloading.</p>
        </div>
        <div>
          <label for="overloadMultiplier">Overload death multiplier</label>
          <input id="overloadMultiplier" type="number" min="1" step="0.1" value="2" />
          <p class="hint">When infections exceed capacity, deaths accelerate by this multiplier.</p>
        </div>
      </div>

      <div class="status-grid" aria-live="polite">
        <div>
          <span class="label">Current infected</span>
          <strong id="infectedCount">0</strong>
        </div>
        <div>
          <span class="label">Effective death chance</span>
          <strong id="deathProbability">0.00%</strong>
        </div>
      </div>

      <div class="toggle-row">
        <div>
          <label for="lockdownToggle">Lockdown</label>
          <p class="hint">Toggle a lockdown to reduce movement speeds across the simulation.</p>
        </div>
        <label class="switch">
          <input id="lockdownToggle" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>
      <p id="lockdownStatus" class="status">Lockdown inactive — agents moving normally.</p>
    </section>

    <section class="visualization" aria-live="polite">
      <h2>Movement preview</h2>
      <div class="agent-field">
        <div class="agent a1"></div>
        <div class="agent a2"></div>
        <div class="agent a3"></div>
        <div class="agent a4"></div>
        <div class="agent a5"></div>
        <div class="agent a6"></div>
      </div>
      <p class="hint">When lockdown is active, these sample agents crawl to show how movement slows down.</p>
    </section>

    <section class="charts" aria-live="polite">
      <h2>Epidemic curves</h2>
      <p class="hint">Line colors switch when interventions change. Dotted markers indicate when lockdown or transmission updates were applied.</p>
      <div class="chart-wrapper">
        <canvas id="curveChart" height="260"></canvas>
      </div>
    </section>

    <section class="help" aria-live="polite">
      <h2>Help</h2>
      <p>
        The transmission modifier multiplies the base infection probability in the simulation. A value of 1.0 keeps the default behavior,
        while lower numbers dampen spread and higher numbers (up to 1.0) raise the likelihood that an encounter results in infection.
        The <strong>Transmission modifier</strong> indicator shows both the requested multiplier and the resulting per-contact chance computed by the backend.
      </p>
      <p>
        Adjust the slider to send a <strong>ControlUpdate</strong> to the server. Everyone connected to the simulation will see the current rate stay in sync.
        Each update also drops a dotted marker on the charts so you can read the impact of an intervention.
      </p>
      <p>
        Use the lockdown switch to freeze movement: the backend sets a global speed modifier to a tenth of normal and broadcasts the updated state so all clients animate consistently.
        The <strong>Lockdown status</strong> badge and speed readout mirror the live speed modifier streaming from the server.
      </p>
      <p>
        The capacity controls set how many active infections hospitals can absorb. When <strong>infected</strong> exceeds capacity, the simulation amplifies per-tick death probability by the overload multiplier.
        The <strong>Capacity utilization</strong> bar fills as infections climb and turns warning red when the system is overloaded.
      </p>
      <p>
        The epidemic curves plot infected counts alongside death probability. Color shifts reflect whether the simulation is in a baseline or lockdown phase, and markers show when controls changed so you can compare before-and-after trends.
      </p>
    </section>
  </main>

  <script type="module" src="/js/app.js"></script>
</body>
</html>
